{"version":3,"sources":["ApiV2.ts"],"names":["_rootBaseUrl","Config","api","scheme","host","_apiBaseUrl","rootBaseUrl","port","ApiV2Error","ExtendableError","constructor","message","code","ApiV2Client","clientForUser","user","sessionSecret","setClientName","name","exponentClient","options","getAsync","methodName","args","extraOptions","returnEntireResponse","_requestAsync","httpMethod","queryParameters","postAsync","data","body","putAsync","deleteAsync","extraRequestOptions","url","reqOptions","method","headers","params","paramsSerializer","QueryString","stringify","response","result","axios","request","e","maybeErrorData","_","errors","length","responseError","error","serverStack","stack","details"],"mappings":"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","sourcesContent":["import merge from 'lodash/merge';\nimport ExtendableError from 'es6-error';\nimport QueryString from 'querystring';\nimport axios, { AxiosRequestConfig } from 'axios';\nimport idx from 'idx';\nimport { JSONObject, JSONValue } from '@expo/json-file';\n\nimport Config from './Config';\n\n// These aren't constants because some commands switch between staging and prod\nfunction _rootBaseUrl() {\n  return `${Config.api.scheme}://${Config.api.host}`;\n}\n\nfunction _apiBaseUrl() {\n  let rootBaseUrl = _rootBaseUrl();\n  if (Config.api.port) {\n    rootBaseUrl += ':' + Config.api.port;\n  }\n  return rootBaseUrl + '/--/api/v2';\n}\n\nexport class ApiV2Error extends ExtendableError {\n  code: string;\n  details?: JSONValue;\n  serverStack?: string;\n  readonly _isApiError = true;\n\n  constructor(message: string, code: string = 'UNKNOWN') {\n    super(message);\n    this.code = code;\n  }\n}\n\ntype RequestOptions = {\n  httpMethod: 'get' | 'post' | 'put' | 'delete';\n  queryParameters?: QueryParameters;\n  body?: JSONObject;\n};\n\ntype QueryParameters = { [key: string]: string | number | boolean | null };\n\ntype APIV2ClientOptions = {\n  sessionSecret?: string;\n};\n\nexport default class ApiV2Client {\n  static exponentClient: string = 'xdl';\n  sessionSecret: string | null = null;\n\n  static clientForUser(user?: APIV2ClientOptions | null): ApiV2Client {\n    if (user && user.sessionSecret) {\n      return new ApiV2Client({ sessionSecret: user.sessionSecret });\n    }\n\n    return new ApiV2Client();\n  }\n\n  static setClientName(name: string) {\n    ApiV2Client.exponentClient = name;\n  }\n\n  constructor(options: APIV2ClientOptions = {}) {\n    if (options.sessionSecret) {\n      this.sessionSecret = options.sessionSecret;\n    }\n  }\n\n  async getAsync(\n    methodName: string,\n    args: QueryParameters = {},\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'get',\n        queryParameters: args,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async postAsync(\n    methodName: string,\n    data?: JSONObject,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'post',\n        body: data,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async putAsync(\n    methodName: string,\n    data: JSONObject,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'put',\n        body: data,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async deleteAsync(\n    methodName: string,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'delete',\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async _requestAsync(\n    methodName: string,\n    options: RequestOptions,\n    extraRequestOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    const url = `${_apiBaseUrl()}/${methodName}`;\n    let reqOptions: AxiosRequestConfig = {\n      url,\n      method: options.httpMethod,\n      headers: {\n        'Exponent-Client': ApiV2Client.exponentClient,\n      },\n    };\n\n    if (this.sessionSecret) {\n      reqOptions.headers['Expo-Session'] = this.sessionSecret;\n    }\n\n    // Handle qs\n    if (options.queryParameters) {\n      reqOptions.params = options.queryParameters;\n      reqOptions.paramsSerializer = QueryString.stringify;\n    }\n\n    // Handle body\n    if (options.body) {\n      reqOptions.data = options.body;\n    }\n\n    reqOptions = merge({}, reqOptions, extraRequestOptions);\n    let response;\n    let result;\n    try {\n      response = await axios.request(reqOptions);\n      result = response.data;\n    } catch (e) {\n      const maybeErrorData = idx(e, _ => _.response.data.errors.length);\n      if (maybeErrorData) {\n        result = e.response.data;\n      } else {\n        throw e;\n      }\n    }\n\n    if (result.errors && result.errors.length) {\n      let responseError = result.errors[0];\n      let error = new ApiV2Error(responseError.message, responseError.code);\n      error.serverStack = responseError.stack;\n      error.details = responseError.details;\n      throw error;\n    }\n\n    return returnEntireResponse ? response : result.data;\n  }\n}\n"],"file":"../ApiV2.js","sourceRoot":"/@expo/xdl@55.0.14/src"}