{"version":3,"sources":["Versions.ts"],"names":["versionsAsync","api","ApiV2Client","versionCache","Cacher","getAsync","path","join","__dirname","sdkVersionsAsync","sdkVersions","setVersionsAsync","value","user","UserManager","getCurrentUserAsync","clientForUser","secret","process","env","EXPO_VERSIONS_SECRET","Error","postAsync","gteSdkVersion","expJson","sdkVersion","semver","gte","e","XDLError","lteSdkVersion","lte","parseSdkVersionFromTag","tag","startsWith","substring","newestSdkVersionAsync","result","highestMajorVersion","key","major","version","data","oldestSupportedMajorVersionAsync","supportedVersions","v","isDeprecated","versionNumbers","push","Math","min","facebookReactNativeVersionsAsync","facebookReactNativeVersions","Set","facebookReactNativeVersion","add","Array","from","facebookReactNativeVersionToExpoVersionAsync","valid","currentSdkVersion","minor","gt","canTurtleBuildSdkVersion","platform","getSdkVersionsSupportedByTurtle","supportedVersionsForPlatform","indexOf"],"mappings":"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","sourcesContent":["import path from 'path';\n\nimport { ExpoConfig } from '@expo/config';\nimport { JSONObject } from '@expo/json-file';\nimport forEach from 'lodash/forEach';\nimport pickBy from 'lodash/pickBy';\nimport get from 'lodash/get';\nimport semver from 'semver';\n\nimport ApiV2Client from './ApiV2';\nimport { Cacher } from './tools/FsCache';\nimport XDLError from './XDLError';\nimport UserManager from './User';\n\ntype SDKVersion = {\n  androidExpoViewUrl?: string;\n  expoReactNativeTag: string;\n  /* deprecated */ exponentReactNativeTag?: string;\n  expokitNpmPackage?: string;\n  facebookReactNativeVersion: string;\n  facebookReactVersion?: string;\n  iosExpoViewUrl?: string;\n  /* deprecated */ iosExponentViewUrl?: string;\n  iosVersion?: string;\n  isDeprecated?: boolean;\n  packagesToInstallWhenEjecting?: { [name: string]: string };\n  releaseNoteUrl?: string;\n};\n\ntype SDKVersions = { [version: string]: SDKVersion };\ntype TurtleSDKVersions = { android: string[]; ios: string[]; };\ntype TurtleSDKVersionsOld = { android: string; ios: string };\n\ntype Versions = {\n  androidUrl: 'https://d1ahtucjixef4r.cloudfront.net/Exponent-2.11.4.apk';\n  androidVersion: '2.11.4';\n  iosUrl: 'https://dpq5q02fu5f55.cloudfront.net/Exponent-2.11.1.tar.gz';\n  iosVersion: '2.11.1';\n  sdkVersions: SDKVersions;\n  /* deprecated */ starterApps: unknown;\n  /* deprecated */ templates: unknown[];\n  /* deprecated */ templatesv2: unknown[];\n  turtleSdkVersions: TurtleSDKVersionsOld;\n};\n\nexport async function versionsAsync(): Promise<Versions> {\n  const api = new ApiV2Client();\n  const versionCache = new Cacher(\n    () => api.getAsync('versions/latest'),\n    'versions.json',\n    0,\n    path.join(__dirname, '../caches/versions.json')\n  );\n  return await versionCache.getAsync();\n}\n\nexport async function sdkVersionsAsync(): Promise<SDKVersions> {\n  const { sdkVersions } = await versionsAsync();\n  return sdkVersions;\n}\n\nexport async function setVersionsAsync(value: any) {\n  const user = await UserManager.getCurrentUserAsync();\n  const api = ApiV2Client.clientForUser(user);\n  const secret = process.env.EXPO_VERSIONS_SECRET;\n  if (!secret)\n    throw new Error(\n      'Versions.setVersionsAsync: EXPO_VERSIONS_SECRET environment variable is required'\n    );\n  await api.postAsync('versions/update', {\n    value: value as JSONObject,\n    secret,\n  });\n}\n\nexport function gteSdkVersion(expJson: ExpoConfig, sdkVersion: string): boolean {\n  if (!expJson.sdkVersion) {\n    return false;\n  }\n\n  if (expJson.sdkVersion === 'UNVERSIONED') {\n    return true;\n  }\n\n  try {\n    return semver.gte(expJson.sdkVersion, sdkVersion);\n  } catch (e) {\n    throw new XDLError(\n      'INVALID_VERSION',\n      `${expJson.sdkVersion} is not a valid version. Must be in the form of x.y.z`\n    );\n  }\n}\n\nexport function lteSdkVersion(expJson: ExpoConfig, sdkVersion: string): boolean {\n  if (!expJson.sdkVersion) {\n    return false;\n  }\n\n  if (expJson.sdkVersion === 'UNVERSIONED') {\n    return false;\n  }\n\n  try {\n    return semver.lte(expJson.sdkVersion, sdkVersion);\n  } catch (e) {\n    throw new XDLError(\n      'INVALID_VERSION',\n      `${expJson.sdkVersion} is not a valid version. Must be in the form of x.y.z`\n    );\n  }\n}\n\nexport function parseSdkVersionFromTag(tag: string): string {\n  if (tag.startsWith('sdk-')) {\n    return tag.substring(4);\n  }\n\n  return tag;\n}\n\nexport async function newestSdkVersionAsync(): Promise<{\n  version: string;\n  data: SDKVersion | null;\n}> {\n  let sdkVersions = await sdkVersionsAsync();\n  let result = null;\n  let highestMajorVersion = '0.0.0';\n  forEach(sdkVersions, (value, key) => {\n    if (semver.major(key) > semver.major(highestMajorVersion)) {\n      highestMajorVersion = key;\n      result = value;\n    }\n  });\n  return {\n    version: highestMajorVersion,\n    data: result,\n  };\n}\n\nexport async function oldestSupportedMajorVersionAsync(): Promise<number> {\n  const sdkVersions = await sdkVersionsAsync();\n  const supportedVersions = pickBy(sdkVersions, v => !v.isDeprecated);\n  let versionNumbers: number[] = [];\n  forEach(supportedVersions, (value, key) => {\n    versionNumbers.push(semver.major(key));\n  });\n  return Math.min(...versionNumbers);\n}\n\nexport async function facebookReactNativeVersionsAsync(): Promise<string[]> {\n  let sdkVersions = await sdkVersionsAsync();\n  let facebookReactNativeVersions = new Set<string>();\n\n  forEach(sdkVersions, value => {\n    if (value.facebookReactNativeVersion) {\n      facebookReactNativeVersions.add(value.facebookReactNativeVersion);\n    }\n  });\n\n  return Array.from(facebookReactNativeVersions);\n}\n\nexport async function facebookReactNativeVersionToExpoVersionAsync(\n  facebookReactNativeVersion: string\n): Promise<string | null> {\n  if (!semver.valid(facebookReactNativeVersion)) {\n    throw new XDLError(\n      'INVALID_VERSION',\n      `${facebookReactNativeVersion} is not a valid version. Must be in the form of x.y.z`\n    );\n  }\n\n  let sdkVersions = await sdkVersionsAsync();\n  let currentSdkVersion: string | null = null;\n\n  forEach(sdkVersions, (value, key) => {\n    if (\n      semver.major(value.facebookReactNativeVersion) === semver.major(facebookReactNativeVersion) &&\n      semver.minor(value.facebookReactNativeVersion) === semver.minor(facebookReactNativeVersion) &&\n      (!currentSdkVersion || semver.gt(key, currentSdkVersion))\n    ) {\n      currentSdkVersion = key;\n    }\n  });\n\n  return currentSdkVersion;\n}\n\nexport async function canTurtleBuildSdkVersion(\n  sdkVersion: string,\n  platform: keyof TurtleSDKVersions\n): Promise<boolean> {\n  if (sdkVersion === 'UNVERSIONED') {\n    return true;\n  }\n\n  if (semver.valid(sdkVersion) == null) {\n    throw new XDLError(\n      'INVALID_VERSION',\n      `\"${sdkVersion}\" is not a valid version. Must be in the form of x.y.z`\n    );\n  }\n\n  const supportedVersions = await getSdkVersionsSupportedByTurtle();\n  const supportedVersionsForPlatform = get(supportedVersions, platform, [] as string[]);\n  return supportedVersionsForPlatform.indexOf(sdkVersion) !== -1;\n}\n\nasync function getSdkVersionsSupportedByTurtle(): Promise<TurtleSDKVersions> {\n  const api = new ApiV2Client();\n  return await api.getAsync('standalone-build/supportedSDKVersions');\n}\n"],"file":"../Versions.js","sourceRoot":"/@expo/xdl@55.0.14/src"}