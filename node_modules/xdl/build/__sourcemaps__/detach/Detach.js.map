{"version":3,"sources":["detach/Detach.js"],"names":["async","message","ok","await","inquirer","prompt","type","name","yesnoAsync","projectRoot","options","let","user","UserManager","ensureLoggedInAsync","Error","username","configName","configPath","configNamespace","ProjectUtils","findConfigFileAsync","exp","pkg","readConfigJsonAsync","experienceName","slug","experienceUrl","hasIosDirectory","isDirectory","path","join","hasAndroidDirectory","ErrorCode","DIRECTORY_ALREADY_EXISTS","process","platform","response","logger","info","sdkVersion","majorSdkVersion","parseSdkMajorVersion","versions","Versions","versionsAsync","sdkVersionConfig","sdkVersions","androidExpoViewUrl","iosExpoViewUrl","env","EXPO_VIEW_DIR","warn","isDetached","detach","detachedUUID","uuid","v4","replace","generatedScheme","scheme","gteSdkVersion","expoDirectory","fs","mkdirpSync","context","StandaloneContext","createUserContext","isIosSupported","force","ios","bundleIdentifier","iosBundleIdentifier","validate","value","test","detachIOSAsync","IosWorkspace","addDetachedConfigToExp","android","package","androidPackage","androidDirectory","rimraf","sync","detachAndroidAsync","OldAndroidDetach","AndroidShellApp","config","writeFile","JSON","stringify","reactNativeVersion","expoReactNativeTag","nodeModulesPath","resolve","dependencies","installPackageAsync","silent","e","spawnAsync","cwd","expokitNpmPackage","packageName","split","packageVersion","detachAsync","createDetachedAsync","IosNSBundle","configureAsync","expoViewUrl","androidProjectDirectory","data","projectPath","tmpExpoDirectory","copyInitialShellAppFilesAsync","Api","downloadAsync","extract","runShellAppModificationsAsync","rimrafDontThrow","configFilePath","doesBuildConstantsExist","existsSync","IosPlist","createBlankAsync","ensureBuildConstantsExistsIOSAsync","iosProjectDirectory","expoKitVersion","podfileLockPath","podfileLock","readFile","expoKitVersionRegex","match","exec","_getIosExpoKitVersionThrowErrorAsync","projectDir","args","prepareDetachedUserContextIosAsync","prepareDetachedServiceContextIosAsync","prepareDetachedBuildIosAsync","expoRootDir","workspaceSourcePath","buildFlags","StandaloneBuildFlags","createIos","createServiceContext","supportingDirectory","getPaths","prodApiKeys","_readDefaultApiKeysAsync","expoSourcePath","modifyAsync","constantsConfig","contextType","STANDALONE_CONTEXT_TYPE","EXPO_RUNTIME_VERSION","API_SERVER_ENDPOINT","ENVIRONMENT","DEFAULT_API_KEYS","TEMPORARY_SDK_VERSION","jsonFilePath","keys","allKeys","readAsync","validKeys","key","hasOwnProperty","includes","podsDirectory","rnPodDirectory","rnFilesToDelete","glob","i","length","unlink","skipXcodeConfig","devUrl","UrlUtils","constructManifestUrlAsync","defaultApiKeys","developmentUrl","buildConstantsFileName","expoBuildConstantsMatches","expoBuildConstants","regexFileAsync","prepareDetachedBuildAsync","publishManifestPath","bundledManifestPath","manifest","parse","ex","AssetBundle","bundleAsync","bundledAssets","dest","bundleAssetsAsync"],"mappings":"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","file":"../../detach/Detach.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n/**\n * @flow\n */\n\n'use strict';\n\n// Set EXPO_VIEW_DIR to universe/exponent to test locally\n\nimport fs from 'fs-extra';\nimport JsonFile from '@expo/json-file';\nimport path from 'path';\nimport process from 'process';\nimport rimraf from 'rimraf';\nimport glob from 'glob-promise';\nimport uuid from 'uuid';\nimport inquirer from 'inquirer';\nimport spawnAsync from '@expo/spawn-async';\n\nimport {\n  isDirectory,\n  parseSdkMajorVersion,\n  rimrafDontThrow,\n  regexFileAsync,\n} from './ExponentTools';\n\nimport * as AssetBundle from './AssetBundle';\nimport * as IosPlist from './IosPlist';\nimport * as IosNSBundle from './IosNSBundle';\nimport * as IosWorkspace from './IosWorkspace';\nimport * as AndroidShellApp from './AndroidShellApp';\nimport * as OldAndroidDetach from './OldAndroidDetach';\n\nimport Api from '../Api';\nimport ErrorCode from '../ErrorCode';\nimport * as ProjectUtils from '../project/ProjectUtils';\nimport UserManager from '../User';\nimport XDLError from '../XDLError';\nimport StandaloneBuildFlags from './StandaloneBuildFlags';\nimport StandaloneContext from './StandaloneContext';\nimport * as UrlUtils from '../UrlUtils';\nimport * as Versions from '../Versions';\nimport installPackageAsync from './installPackageAsync';\nimport logger from './Logger';\n\nasync function yesnoAsync(message) {\n  const { ok } = await inquirer.prompt([\n    {\n      type: 'confirm',\n      name: 'ok',\n      message,\n    },\n  ]);\n  return ok;\n}\n\nexport async function detachAsync(projectRoot: string, options: any = {}) {\n  let user = await UserManager.ensureLoggedInAsync();\n\n  if (!user) {\n    throw new Error('Internal error -- somehow detach is being run in offline mode.');\n  }\n\n  let username = user.username;\n  const { configName, configPath, configNamespace } = await ProjectUtils.findConfigFileAsync(\n    projectRoot\n  );\n  let { exp, pkg } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n  if (!exp) throw new Error(`Couldn't read ${configName}`);\n  if (!pkg) throw new Error(`Couldn't read package.json`);\n  let experienceName = `@${username}/${exp.slug}`;\n  let experienceUrl = `exp://exp.host/${experienceName}`;\n\n  // Check to make sure project isn't fully detached already\n  let hasIosDirectory = isDirectory(path.join(projectRoot, 'ios'));\n  let hasAndroidDirectory = isDirectory(path.join(projectRoot, 'android'));\n\n  if (hasIosDirectory && hasAndroidDirectory) {\n    throw new XDLError(\n      ErrorCode.DIRECTORY_ALREADY_EXISTS,\n      'Error detaching. `ios` and `android` directories already exist.'\n    );\n  }\n\n  // Project was already detached on Windows or Linux\n  if (!hasIosDirectory && hasAndroidDirectory && process.platform === 'darwin') {\n    let response = await yesnoAsync(\n      `This will add an Xcode project and leave your existing Android project alone. Enter 'yes' to continue:`\n    );\n    if (!response) {\n      logger.info('Exiting...');\n      return false;\n    }\n  }\n\n  if (hasIosDirectory && !hasAndroidDirectory) {\n    throw new Error('`ios` directory already exists. Please remove it and try again.');\n  }\n\n  logger.info('Validating project manifest...');\n  if (!exp.name) {\n    throw new Error(`${configName} is missing \\`name\\``);\n  }\n\n  if (!exp.sdkVersion) {\n    throw new Error(`${configName} is missing \\`sdkVersion\\``);\n  }\n\n  let majorSdkVersion = parseSdkMajorVersion(exp.sdkVersion);\n  if (majorSdkVersion < 16) {\n    throw new Error(`${configName} must be updated to SDK 16.0.0 or newer to be detached.`);\n  }\n\n  const versions = await Versions.versionsAsync();\n  let sdkVersionConfig = versions.sdkVersions[exp.sdkVersion];\n  if (\n    !sdkVersionConfig ||\n    !sdkVersionConfig.androidExpoViewUrl ||\n    !sdkVersionConfig.iosExpoViewUrl\n  ) {\n    if (process.env.EXPO_VIEW_DIR) {\n      logger.warn(\n        `Detaching is not supported for SDK ${\n          exp.sdkVersion\n        }; ignoring this because you provided EXPO_VIEW_DIR`\n      );\n      sdkVersionConfig = {};\n    } else {\n      throw new Error(`Detaching is not supported for SDK version ${exp.sdkVersion}`);\n    }\n  }\n\n  // Modify exp.json\n  exp.isDetached = true;\n\n  if (!exp.detach) {\n    exp.detach = {};\n  }\n\n  let detachedUUID = uuid.v4().replace(/-/g, '');\n  let generatedScheme = `exp${detachedUUID}`;\n\n  if (!exp.detach.scheme && !Versions.gteSdkVersion(exp, '27.0.0')) {\n    // set this for legacy purposes\n    exp.detach.scheme = generatedScheme;\n  }\n\n  if (!exp.scheme) {\n    logger.info(\n      `You have not specified a custom scheme for deep linking. A default value of ${generatedScheme} will be used. You can change this later by following the instructions in this guide: https://docs.expo.io/versions/latest/workflow/linking`\n    );\n    exp.scheme = generatedScheme;\n  }\n\n  let expoDirectory = path.join(projectRoot, '.expo-source');\n  fs.mkdirpSync(expoDirectory);\n  const context = StandaloneContext.createUserContext(projectRoot, exp, experienceUrl);\n\n  // iOS\n  let isIosSupported = true;\n  if (process.platform !== 'darwin') {\n    if (options && options.force) {\n      logger.warn(\n        `You are not running macOS, but have provided the --force option, so we will attempt to generate an iOS project anyway. This might fail.`\n      );\n    } else {\n      logger.warn(`Skipping iOS because you are not running macOS.`);\n      isIosSupported = false;\n    }\n  }\n\n  if (!hasIosDirectory && isIosSupported) {\n    if (!exp.ios) {\n      exp.ios = {};\n    }\n    if (!exp.ios.bundleIdentifier) {\n      logger.info(\n        `You'll need to specify an iOS bundle identifier. See: https://docs.expo.io/versions/latest/guides/configuration.html#bundleidentifier`\n      );\n      const { iosBundleIdentifier } = await inquirer.prompt([\n        {\n          name: 'iosBundleIdentifier',\n          message: 'What would you like your iOS bundle identifier to be?',\n          validate: value => /^[a-zA-Z][a-zA-Z0-9\\-\\.]+$/.test(value),\n        },\n      ]);\n      exp.ios.bundleIdentifier = iosBundleIdentifier;\n    }\n\n    await detachIOSAsync(context);\n    exp = IosWorkspace.addDetachedConfigToExp(exp, context);\n    exp.detach.iosExpoViewUrl = sdkVersionConfig.iosExpoViewUrl;\n  }\n\n  // Android\n  if (!hasAndroidDirectory) {\n    if (!exp.android) {\n      exp.android = {};\n    }\n    if (!exp.android.package) {\n      logger.info(\n        `You'll need to specify an Android package name. See: https://docs.expo.io/versions/latest/guides/configuration.html#package`\n      );\n      const { androidPackage } = await inquirer.prompt([\n        {\n          name: 'androidPackage',\n          message: 'What would you like your Android package name to be?',\n          validate: value =>\n            /^[a-zA-Z][a-zA-Z0-9\\_]*(\\.[a-zA-Z][a-zA-Z0-9\\_]*)+$/.test(value)\n              ? true\n              : \"Invalid format of Android package name (only alphanumeric characters, '.' and '_' are allowed, and each '.' must be followed by a letter)\",\n        },\n      ]);\n      exp.android.package = androidPackage;\n    }\n\n    let androidDirectory = path.join(expoDirectory, 'android');\n    rimraf.sync(androidDirectory);\n    fs.mkdirpSync(androidDirectory);\n    if (Versions.gteSdkVersion(exp, '24.0.0')) {\n      await detachAndroidAsync(context, sdkVersionConfig.androidExpoViewUrl);\n    } else {\n      await OldAndroidDetach.detachAndroidAsync(\n        projectRoot,\n        androidDirectory,\n        exp.sdkVersion,\n        experienceUrl,\n        exp,\n        sdkVersionConfig.androidExpoViewUrl\n      );\n    }\n    exp = AndroidShellApp.addDetachedConfigToExp(exp, context);\n    exp.detach.androidExpoViewUrl = sdkVersionConfig.androidExpoViewUrl;\n  }\n\n  logger.info('Writing ExpoKit configuration...');\n  // Update exp.json/app.json\n  // if we're writing to app.json, we need to place the configuration under the expo key\n  const config = configNamespace ? { [configNamespace]: exp } : exp;\n  await fs.writeFile(configPath, JSON.stringify(config, null, 2));\n\n  let reactNativeVersion, expoReactNativeTag;\n  if (sdkVersionConfig && sdkVersionConfig.expoReactNativeTag) {\n    expoReactNativeTag = sdkVersionConfig.expoReactNativeTag;\n    reactNativeVersion = `https://github.com/expo/react-native/archive/${expoReactNativeTag}.tar.gz`;\n  } else {\n    if (process.env.EXPO_VIEW_DIR) {\n      // ignore, using test directory\n    } else {\n      throw new Error(`Expo's React Native fork does not support this SDK version.`);\n    }\n  }\n\n  const nodeModulesPath = exp.nodeModulesPath\n    ? path.resolve(projectRoot, exp.nodeModulesPath)\n    : projectRoot;\n  if (reactNativeVersion && pkg.dependencies['react-native'] !== reactNativeVersion) {\n    logger.info('Installing the Expo fork of react-native...');\n    try {\n      await installPackageAsync(nodeModulesPath, 'react-native', reactNativeVersion, {\n        silent: true,\n      });\n    } catch (e) {\n      logger.warn('Unable to install the Expo fork of react-native.');\n      logger.warn(`Please install react-native@${reactNativeVersion} to complete detaching.`);\n    }\n  }\n\n  // Add expokitNpmPackage if it is supported. Was added before SDK 29.\n  if (process.env.EXPO_VIEW_DIR) {\n    logger.info(`Installing 'expokit' package...`);\n    await spawnAsync('yarn', ['link'], {\n      cwd: path.join(process.env.EXPO_VIEW_DIR, 'expokit-npm-package'),\n    });\n    await spawnAsync('yarn', ['link', 'expokit'], {\n      cwd: nodeModulesPath,\n    });\n  } else if (sdkVersionConfig.expokitNpmPackage) {\n    logger.info(`Installing 'expokit' package...`);\n    try {\n      let packageName = sdkVersionConfig.expokitNpmPackage.split('@')[0];\n      let packageVersion = sdkVersionConfig.expokitNpmPackage.split('@')[1];\n      await installPackageAsync(nodeModulesPath, packageName, packageVersion, {\n        silent: true,\n      });\n    } catch (e) {\n      logger.warn(`Unable to install ${sdkVersionConfig.expokitNpmPackage}.`);\n      logger.warn('Please install manually to complete detaching.');\n    }\n  }\n\n  logger.info(\n    'Finished detaching your project! Look in the `android` and `ios` directories for the respective native projects. Follow the ExpoKit guide at https://docs.expo.io/versions/latest/guides/expokit.html to get your project running.'\n  );\n  return true;\n}\n\n/**\n *  Create a detached Expo iOS app pointing at the given project.\n */\nasync function detachIOSAsync(context: StandaloneContext) {\n  await IosWorkspace.createDetachedAsync(context);\n\n  logger.info('Configuring iOS project...');\n  await IosNSBundle.configureAsync(context);\n\n  logger.info(`iOS detach is complete!`);\n}\n\nasync function detachAndroidAsync(context: StandaloneContext, expoViewUrl: string) {\n  if (context.type !== 'user') {\n    throw new Error(`detachAndroidAsync only supports user standalone contexts`);\n  }\n\n  logger.info('Moving Android project files...');\n  let androidProjectDirectory = path.join(context.data.projectPath, 'android');\n  let tmpExpoDirectory;\n  if (process.env.EXPO_VIEW_DIR) {\n    // Only for testing\n    await AndroidShellApp.copyInitialShellAppFilesAsync(\n      path.join(process.env.EXPO_VIEW_DIR, 'android'),\n      androidProjectDirectory,\n      true,\n      context.data.exp.sdkVersion\n    );\n  } else {\n    tmpExpoDirectory = path.join(context.data.projectPath, 'temp-android-directory');\n    fs.mkdirpSync(tmpExpoDirectory);\n    logger.info('Downloading Android code...');\n    await Api.downloadAsync(expoViewUrl, tmpExpoDirectory, { extract: true });\n    await AndroidShellApp.copyInitialShellAppFilesAsync(\n      tmpExpoDirectory,\n      androidProjectDirectory,\n      true,\n      context.data.exp.sdkVersion\n    );\n  }\n\n  logger.info('Updating Android app...');\n  await AndroidShellApp.runShellAppModificationsAsync(context, context.data.exp.sdkVersion);\n\n  // Clean up\n  logger.info('Cleaning up Android...');\n  if (!process.env.EXPO_VIEW_DIR) {\n    rimrafDontThrow(tmpExpoDirectory);\n  }\n  logger.info('Android detach is complete!\\n');\n}\n\nasync function ensureBuildConstantsExistsIOSAsync(configFilePath: string) {\n  // EXBuildConstants is included in newer ExpoKit projects.\n  // create it if it doesn't exist.\n  const doesBuildConstantsExist = fs.existsSync(\n    path.join(configFilePath, 'EXBuildConstants.plist')\n  );\n  if (!doesBuildConstantsExist) {\n    await IosPlist.createBlankAsync(configFilePath, 'EXBuildConstants');\n    logger.info('Created `EXBuildConstants.plist` because it did not exist yet');\n  }\n}\n\nasync function _getIosExpoKitVersionThrowErrorAsync(iosProjectDirectory: string) {\n  let expoKitVersion = '';\n  const podfileLockPath = path.join(iosProjectDirectory, 'Podfile.lock');\n  try {\n    const podfileLock = await fs.readFile(podfileLockPath, 'utf8');\n    const expoKitVersionRegex = /ExpoKit\\/Core\\W?\\(([0-9\\.]+)\\)/gi;\n    let match = expoKitVersionRegex.exec(podfileLock);\n    expoKitVersion = match[1];\n  } catch (e) {\n    throw new Error(\n      `Unable to read ExpoKit version from Podfile.lock. Make sure your project depends on ExpoKit. (${e})`\n    );\n  }\n  return expoKitVersion;\n}\n\nasync function prepareDetachedBuildIosAsync(projectDir: string, args: any) {\n  const { exp } = await ProjectUtils.readConfigJsonAsync(projectDir);\n  if (exp) {\n    return prepareDetachedUserContextIosAsync(projectDir, exp, args);\n  } else {\n    return prepareDetachedServiceContextIosAsync(projectDir, args);\n  }\n}\n\nasync function prepareDetachedServiceContextIosAsync(projectDir: string, args: any) {\n  // service context\n  // TODO: very brittle hack: the paths here are hard coded to match the single workspace\n  // path generated inside IosShellApp. When we support more than one path, this needs to\n  // be smarter.\n  const expoRootDir = path.join(projectDir, '..', '..');\n  const workspaceSourcePath = path.join(projectDir, 'default');\n  const buildFlags = StandaloneBuildFlags.createIos('Release', { workspaceSourcePath });\n  const context = StandaloneContext.createServiceContext(\n    expoRootDir,\n    null,\n    null,\n    null,\n    /* testEnvironment */ 'none',\n    buildFlags,\n    null,\n    null\n  );\n  const { iosProjectDirectory, supportingDirectory } = IosWorkspace.getPaths(context);\n  const expoKitVersion = await _getIosExpoKitVersionThrowErrorAsync(iosProjectDirectory);\n\n  // use prod api keys if available\n  const prodApiKeys = await _readDefaultApiKeysAsync(\n    path.join(context.data.expoSourcePath, '__internal__', 'keys.json')\n  );\n\n  const { exp } = await ProjectUtils.readConfigJsonAsync(expoRootDir);\n\n  await IosPlist.modifyAsync(supportingDirectory, 'EXBuildConstants', constantsConfig => {\n    // verify that we are actually in a service context and not a misconfigured project\n    const contextType = constantsConfig.STANDALONE_CONTEXT_TYPE;\n    if (contextType !== 'service') {\n      throw new Error(\n        'Unable to configure a project which has no app.json and also no STANDALONE_CONTEXT_TYPE.'\n      );\n    }\n    constantsConfig.EXPO_RUNTIME_VERSION = expoKitVersion;\n    constantsConfig.API_SERVER_ENDPOINT =\n      process.env.ENVIRONMENT === 'staging'\n        ? 'https://staging.exp.host/--/api/v2/'\n        : 'https://exp.host/--/api/v2/';\n    if (prodApiKeys) {\n      constantsConfig.DEFAULT_API_KEYS = prodApiKeys;\n    }\n    if (exp && exp.sdkVersion) {\n      constantsConfig.TEMPORARY_SDK_VERSION = exp.sdkVersion;\n    }\n    return constantsConfig;\n  });\n}\n\nasync function _readDefaultApiKeysAsync(jsonFilePath: string) {\n  if (fs.existsSync(jsonFilePath)) {\n    let keys = {};\n    const allKeys = await new JsonFile(jsonFilePath).readAsync();\n    const validKeys = ['AMPLITUDE_KEY', 'GOOGLE_MAPS_IOS_API_KEY'];\n    for (const key in allKeys) {\n      if (allKeys.hasOwnProperty(key) && validKeys.includes(key)) {\n        keys[key] = allKeys[key];\n      }\n    }\n    return keys;\n  }\n  return null;\n}\n\nasync function prepareDetachedUserContextIosAsync(projectDir: string, exp: any, args: any) {\n  const context = StandaloneContext.createUserContext(projectDir, exp);\n  let { iosProjectDirectory, supportingDirectory } = IosWorkspace.getPaths(context);\n\n  logger.info(`Preparing iOS build at ${iosProjectDirectory}...`);\n  // These files cause @providesModule naming collisions\n  // but are not available until after `pod install` has run.\n  let podsDirectory = path.join(iosProjectDirectory, 'Pods');\n  if (!isDirectory(podsDirectory)) {\n    throw new Error(`Can't find directory ${podsDirectory}, make sure you've run pod install.`);\n  }\n  let rnPodDirectory = path.join(podsDirectory, 'React');\n  if (isDirectory(rnPodDirectory)) {\n    let rnFilesToDelete = await glob(rnPodDirectory + '/**/*.@(js|json)');\n    if (rnFilesToDelete) {\n      for (let i = 0; i < rnFilesToDelete.length; i++) {\n        await fs.unlink(rnFilesToDelete[i]);\n      }\n    }\n  }\n\n  // insert expo development url into iOS config\n  if (!args.skipXcodeConfig) {\n    // populate EXPO_RUNTIME_VERSION from ExpoKit pod version\n    const expoKitVersion = await _getIosExpoKitVersionThrowErrorAsync(iosProjectDirectory);\n\n    // populate development url\n    let devUrl = await UrlUtils.constructManifestUrlAsync(projectDir);\n\n    // populate default api keys\n    const defaultApiKeys = await _readDefaultApiKeysAsync(\n      path.join(podsDirectory, 'ExpoKit', 'template-files', 'keys.json')\n    );\n\n    await ensureBuildConstantsExistsIOSAsync(supportingDirectory);\n    await IosPlist.modifyAsync(supportingDirectory, 'EXBuildConstants', constantsConfig => {\n      constantsConfig.developmentUrl = devUrl;\n      constantsConfig.EXPO_RUNTIME_VERSION = expoKitVersion;\n      if (defaultApiKeys) {\n        constantsConfig.DEFAULT_API_KEYS = defaultApiKeys;\n      }\n      if (exp.sdkVersion) {\n        constantsConfig.TEMPORARY_SDK_VERSION = exp.sdkVersion;\n      }\n      return constantsConfig;\n    });\n  }\n}\n\nexport async function prepareDetachedBuildAsync(projectDir: string, args: any) {\n  if (args.platform === 'ios') {\n    await prepareDetachedBuildIosAsync(projectDir, args);\n  } else {\n    let { exp } = await ProjectUtils.readConfigJsonAsync(projectDir);\n    let buildConstantsFileName = Versions.gteSdkVersion(exp, '24.0.0')\n      ? 'DetachBuildConstants.java'\n      : 'ExponentBuildConstants.java';\n\n    let androidProjectDirectory = path.join(projectDir, 'android');\n    let expoBuildConstantsMatches = await glob(\n      androidProjectDirectory + '/**/' + buildConstantsFileName\n    );\n    if (expoBuildConstantsMatches && expoBuildConstantsMatches.length) {\n      let expoBuildConstants = expoBuildConstantsMatches[0];\n      let devUrl = await UrlUtils.constructManifestUrlAsync(projectDir);\n      await regexFileAsync(\n        /DEVELOPMENT_URL \\= \\\"[^\\\"]*\\\"\\;/,\n        `DEVELOPMENT_URL = \"${devUrl}\";`,\n        expoBuildConstants\n      );\n    }\n  }\n}\n\ntype BundleAssetsArgs = {\n  platform: 'ios' | 'android',\n  // This is the path where assets will be copied to. It should be\n  // `$CONFIGURATION_BUILD_DIR/$UNLOCALIZED_RESOURCES_FOLDER_PATH` on iOS\n  // (see `exponent-view-template.xcodeproj/project.pbxproj` for an example)\n  // and `$buildDir/intermediates/assets/$targetPath` on Android (see\n  // `android/app/expo.gradle` for an example).\n  dest: string,\n};\n\nexport async function bundleAssetsAsync(projectDir: string, args: BundleAssetsArgs) {\n  let { exp } = await ProjectUtils.readConfigJsonAsync(projectDir);\n  if (!exp) {\n    // Don't run assets bundling for the service context.\n    return;\n  }\n  let publishManifestPath =\n    args.platform === 'ios' ? exp.ios.publishManifestPath : exp.android.publishManifestPath;\n  if (!publishManifestPath) {\n    logger.warn(\n      `Skipped assets bundling because the '${\n        args.platform\n      }.publishManifestPath' key is not specified in the app manifest.`\n    );\n    return;\n  }\n  let bundledManifestPath = path.join(projectDir, publishManifestPath);\n  let manifest;\n  try {\n    manifest = JSON.parse(await fs.readFile(bundledManifestPath, 'utf8'));\n  } catch (ex) {\n    throw new Error(\n      `Error reading the manifest file. Make sure the path '${bundledManifestPath}' is correct.\\n\\nError: ${\n        ex.message\n      }`\n    );\n  }\n  await AssetBundle.bundleAsync(null, manifest.bundledAssets, args.dest);\n}\n"],"sourceRoot":"/xdl@52.0.12/src"}